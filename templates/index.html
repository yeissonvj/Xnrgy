<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xnergy Stock Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container container-wide">
        <header class="main-header">
            <h1>Sistema de Análisis de Stock</h1>
            <div class="user-controls">
                <span>Usuario: {{ session.user }}</span>
                <a href="/logout" class="btn-small">Salir</a>
            </div>
        </header>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alerts">
            {% for message in messages %}
            <div class="alert info">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- ACTIONS ROW: RESET BUTTON -->
        <div class="toolbar">
            <div class="status-indicator">
                {% if inventory_loaded %}
                <span class="badge badge-A">Stock en Memoria (Activo)</span>
                {% else %}
                <span class="badge badge-None">Sin Stock Cargado</span>
                {% endif %}
            </div>

            {% if inventory_loaded %}
            <form action="/reset" method="post" style="display:inline;">
                <button type="submit" class="btn-danger btn-sm">Reiniciar Stock y Limpiar</button>
            </form>
            {% endif %}
        </div>

        <!-- UPLOAD FORM -->
        <div class="card form-card">
            <form action="/analyze" method="post" enctype="multipart/form-data" class="upload-form">

                <!-- METADATA INPUTS -->
                <h4 style="margin-bottom: 15px; color: var(--gray-700);">Información del Proyecto</h4>
                <div class="input-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="project">No. Proyecto</label>
                        <input type="text" name="project" id="project" class="form-control" placeholder="Ej: 12345"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="model">Modelo</label>
                        <input type="text" name="model" id="model" class="form-control" placeholder="Ej: XN-200"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="module">Módulo</label>
                        <input type="text" name="module" id="module" class="form-control" placeholder="Ej: Mod-A"
                            required>
                    </div>
                </div>



                <h4 style="margin-bottom: 15px; color: var(--gray-700);">Archivos</h4>
                <div class="input-grid">
                    <div class="file-input-group">
                        <label for="punch_file">PDF Punch</label>
                        <div class="custom-file-input">
                            <input type="file" name="punch_file" id="punch_file" accept=".pdf">
                            <span class="file-name">Seleccionar...</span>
                            <button type="button" class="btn-browse">Explorar</button>
                        </div>
                    </div>

                    <div class="file-input-group">
                        <label for="laser_file">PDF Laser</label>
                        <div class="custom-file-input">
                            <input type="file" name="laser_file" id="laser_file" accept=".pdf">
                            <span class="file-name">Seleccionar...</span>
                            <button type="button" class="btn-browse">Explorar</button>
                        </div>
                    </div>

                    <div class="file-input-group">
                        <label for="inventory_file">
                            Excel Inventario
                            {% if inventory_loaded %} (Opcional) {% else %} (Requerido) {% endif %}
                        </label>
                        <div class="custom-file-input">
                            <input type="file" name="inventory_file" id="inventory_file" accept=".xlsx, .xls" {% if not
                                inventory_loaded %} required {% endif %}>
                            <span class="file-name">Seleccionar...</span>
                            <button type="button" class="btn-browse">Explorar</button>
                        </div>
                    </div>
                </div>

                <div class="rules-section"
                    style="margin-top: 20px; background: var(--gray-50); padding: 15px; border-radius: 8px; border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 10px; color: var(--gray-700);">Reglas de Análisis Activas</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="rule_10034" value="1" checked
                                style="margin-top: 3px; width: 16px; height: 16px; flex-shrink: 0;">
                            <span style="line-height: 1.4;">Regla Part # 10034 (Clasificación 'S')</span>
                        </label>
                        <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="rule_special_parts" value="1" checked
                                style="margin-top: 3px; width: 16px; height: 16px; flex-shrink: 0;">
                            <span style="line-height: 1.4;">Regla Partes Especiales (10089, 10093, 10098, 10016 ->
                                'M')</span>
                        </label>
                        <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                            <input type="checkbox" name="rule_external_low" value="1" checked
                                style="margin-top: 3px; width: 16px; height: 16px; flex-shrink: 0;">
                            <span style="line-height: 1.4;">Regla Stock Externo Bajo (1-2 unidades -> 'M')</span>
                        </label>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--secondary);">
                        * Si se desactiva una regla, el ítem se analizará con lógica estándar (Automatic, Load, BO).
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Ejecutar Análisis</button>
                </div>
            </form>
        </div>

        <!-- ANALYSIS HISTORY LABELS -->
        {% if history %}
        <div class="history-section">
            <h4>Historial de Análisis (Sesión Actual)</h4>
            <div class="history-labels">
                {% for entry in history %}
                <div class="history-label">
                    <div class="hl-header">Análisis {{ entry.id }} <span class="hl-time">{{ entry.timestamp }}</span>
                    </div>

                    {% if entry.metadata and (entry.metadata.project or entry.metadata.model) %}
                    <div class="hl-meta">
                        <strong>Prj:</strong> {{ entry.metadata.project }} |
                        <strong>Mod:</strong> {{ entry.metadata.model }} |
                        <strong>Mód:</strong> {{ entry.metadata.module }}
                    </div>
                    {% endif %}
                    <div class="hl-stats">
                        <span class="stat-item sucess">A: {{ entry.stats.count_a }}</span>
                        <span class="stat-item info">C: {{ entry.stats.count_c }}</span>
                        <span class="stat-item danger">BO: {{ entry.stats.count_bo }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- RESULTS SECTION -->
        {% if results %}
        <div class="results-section">
            <h2>Resultados Última Ejecución</h2>

            <div class="summary-cards">
                <div class="card-mini">Total: <strong>{{ stats.total }}</strong></div>
                <div class="card-mini success">A (Int): <strong>{{ stats.count_a }}</strong></div>
                <div class="card-mini info">C (Ext): <strong>{{ stats.count_c }}</strong></div>
                <div class="card-mini warning">BO/Otro: <strong>{{ stats.count_bo + stats.count_none }}</strong></div>
            </div>

            <div class="actions-right">
                <button onclick="downloadExcel()" class="btn-secondary">Descargar Excel (.xlsx)</button>
            </div>

            <!-- TABS NAVIGATION -->
            <div class="tabs">
                <button class="tab-btn active" onclick="openTab(event, 'tab-punch')">Punch</button>
                <button class="tab-btn" onclick="openTab(event, 'tab-laser')">Laser</button>
                <button class="tab-btn" onclick="openTab(event, 'tab-inventory')">Inventario</button>
            </div>

            <!-- INVENTORY TAB CONTENT -->
            <div id="tab-inventory" class="tab-content">
                <div
                    style="background: var(--gray-50); padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid var(--gray-200);">
                    <strong>Proyecto Actual:</strong>
                    {% if history and history[-1].metadata %}
                    {{ history[-1].metadata.project }} ({{ history[-1].metadata.model }})
                    {% else %}
                    No definido
                    {% endif %}
                </div>

                <div class="table-container">
                    <table class="results_table">
                        <thead>
                            <tr>
                                <th>Part #</th>
                                <th>Matériel</th>
                                <th>Épaisseur</th>
                                <th>Total a Producir</th>
                                <th>Stock Total (Disp.)</th>
                                <th>Faltante (Deficit)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if inventory_summary %}
                            {% for item in inventory_summary %}
                            <tr>
                                <td class="font-mono" style="font-weight: 600;">{{ item.part_number }}</td>
                                <td>{{ item.materiel }}</td>
                                <td>{{ item.epaisseur }}</td>
                                <td>{{ item.total_required }}</td>
                                <td>{{ item.initial_stock }}</td>
                                <td>
                                    {% if item.missing > 0 %}
                                    <span class="badge badge-BO">{{ item.missing }}</span>
                                    {% else %}
                                    <span class="badge badge-A">0</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" style="text-align:center; padding: 20px;">Sin resumen de inventario
                                    disponible.</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PUNCH TAB CONTENT -->
            <div id="tab-punch" class="tab-content active">
                <div class="table-container">
                    <table class="results_table">
                        <thead>
                            <tr>
                                <th>Origen</th>
                                <th>Part #</th>
                                <th>Qté Prod.</th>
                                <th>Stock Int.</th>
                                <th>Stock Ext.</th>
                                <th>Clasif.</th>
                                <th>Razón</th>
                                <th>Faltante Auto.</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in results %}
                            {% if row.origen == 'Punch' %}
                            <tr class="row-{{ row.clasificacion }}">
                                <td>{{ row.origen }}</td>
                                <td class="font-mono">{{ row.part_number }}</td>
                                <td>{{ row.qte_a_produire }}</td>
                                <td>{{ row.stopa_quantity | int }}</td>
                                <td>{{ row.external_quantity | int }}</td>
                                <td><span class="badge badge-{{ row.clasificacion }}">{{ row.clasificacion }}</span>
                                </td>
                                <td class="text-small">{{ row.razon }}</td>
                                <td>
                                    {% if row.deficit_internal %}
                                    <span class="badge badge-BO">{{ row.deficit_internal | int }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- LASER TAB CONTENT -->
            <div id="tab-laser" class="tab-content">
                <div class="table-container">
                    <table class="results_table">
                        <thead>
                            <tr>
                                <th>Origen</th>
                                <th>Part #</th>
                                <th>Qté Prod.</th>
                                <th>Stock Int.</th>
                                <th>Stock Ext.</th>
                                <th>Clasif.</th>
                                <th>Razón</th>
                                <th>Faltante Auto.</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in results %}
                            {% if row.origen == 'Laser' %}
                            <tr class="row-{{ row.clasificacion }}">
                                <td>{{ row.origen }}</td>
                                <td class="font-mono">{{ row.part_number }}</td>
                                <td>{{ row.qte_a_produire }}</td>
                                <td>{{ row.stopa_quantity | int }}</td>
                                <td>{{ row.external_quantity | int }}</td>
                                <td><span class="badge badge-{{ row.clasificacion }}">{{ row.clasificacion }}</span>
                                </td>
                                <td class="text-small">{{ row.razon }}</td>
                                <td>
                                    {% if row.deficit_internal %}
                                    <span class="badge badge-BO">{{ row.deficit_internal | int }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        {% endif %}
    </div>

    <!-- SCRIPTS -->
    <script>
        document.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', function (e) {
                const fileName = e.target.files[0] ? e.target.files[0].name : 'Seleccionar...';
                e.target.parentElement.querySelector('.file-name').textContent = fileName;
                if (e.target.files[0]) e.target.parentElement.classList.add('has-file');
            });
        });

        function downloadExcel() {
            // Identificar qué tab está activa
            var activeTab = document.querySelector('.tab-content.active');
            var activeTabId = activeTab ? activeTab.id : 'tab-punch'; // Default fallback

            var exportType = 'punch';
            if (activeTabId === 'tab-laser') {
                exportType = 'laser';
            } else if (activeTabId === 'tab-inventory') {
                exportType = 'inventory';
            } else if (activeTabId === 'tab-punch') {
                exportType = 'punch';
            }

            // Redirigir al endpoint de descarga
            window.location.href = '/export/' + exportType;
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.className += " active";
        }
    </script>
</body>

</html>